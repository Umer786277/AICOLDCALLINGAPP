{% extends "base.html" %}
{% load static %}

{% block page_content %}
<div class="container-fluid" style="background-color: #343a40; min-height: 100vh;">
    <div class="row justify-content-center align-items-center" style="min-height: 100vh;">
        <div class="col-md-10">
            <div class="card shadow-lg" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <h2 class="text-center mb-4">Create Call</h2>
                    <form id="signupForm" method="POST" action="{% url 'call' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="id_name" class="form-label">Name:</label>
                            {{ form.name }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_phone_number" class="form-label">Phone Number:</label>
                            {{ form.phone_number }}
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100 mt-3">Create Call</button>
                    </form>
                </div>
            </div>

            {% if call_result %}
                <div class="card mt-4">
                    <div class="card-body">
                        <h3 class="card-title">Call Result</h3>
                        {% if call_result.error %}
                            <div class="alert alert-danger" role="alert">
                                <strong>Error:</strong> {{ call_result.error }}
                            </div>
                        {% else %}
                            <div class="card text-white bg-dark mt-3">
                                <div class="card-body">
                                    <h5 class="card-title">Call ID: {{ call_result.call_id }}</h5>
                                    <p class="card-text">Phone Number ID: {{ call_result.phone_number_id }}</p>
                                    <p class="card-text">Created At: {{ call_result.created_at }}</p>
                                    <p class="card-text">Status: {{ call_result.status }}</p>
                                    <p class="card-text">Cost: {{ call_result.cost }}</p>
                                    {% if call_result.details %}
                                        <button type="button" class="btn btn-info mt-3" data-bs-toggle="collapse" data-bs-target="#detailsCollapse" aria-expanded="false" aria-controls="detailsCollapse">
                                            View Details
                                        </button>
                                        <div class="collapse mt-3" id="detailsCollapse">
                                            <div class="card card-body">
                                                <h5>Details</h5>
                                                <p>{{ call_result.details }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="card mt-4">
                    <div class="card-body">
                        <p class="card-text">No call result available.</p>
                    </div>
                </div>
            {% endif %}

            {% if summary %}
                <div class="card mt-4">
                    <div class="card-body">
                        <h3 class="card-title">Call Summary</h3>
                        <p class="card-text">{{ summary }}</p>
                        {% if summary_insights %}
                            <div class="mt-3">
                                <h5>Insights</h5>
                                <ul>
                                    {% for insight in summary_insights %}
                                        <li>{{ insight }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if analytics %}
                <div class="card mt-4">
                    <div class="card-body">
                        <h3 class="card-title">Call Analytics</h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Duration</h5>
                                        <p class="card-text">{{ analytics.duration }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Cost</h5>
                                        <p class="card-text">{{ analytics.cost }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Status</h5>
                                        <p class="card-text">{{ analytics.status }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Example: Chart.js Integration for Analytics -->
                        <canvas id="analyticsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            {% endif %}

            {% if call_result and call_result.lead_generated is not None %}
                <div class="card mt-5">
                    <div class="card-body">
                        <h3 class="card-title">Lead Generation Status</h3>
                        {% if call_result.lead_generated == '1' %}
                            <p class="card-text">Lead was successfully converted.</p>
                        {% elif call_result.lead_generated == '0' %}
                            <p class="card-text">Lead was not converted.</p>
                        {% else %}
                            <p class="card-text">Lead conversion status could not be determined.</p>
                        {% endif %}
                    </div>
                </div>
            {% elif call_result %}
                <div class="card mt-5">
                    <div class="card-body">
                        <h3 class="card-title">Lead Generation Status</h3>
                        <p class="card-text">No lead generation status available.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Example data for Chart.js
        var analyticsData = {
            labels: ["Duration", "Cost", "Status"],
            datasets: [{
                label: 'Analytics',
                data: [
                    {{ analytics.duration }},
                    {{ analytics.cost }},
                    1  // Assuming status is a categorical value, use 1 as a placeholder
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1
            }]
        };

        var analyticsOptions = {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        };

        var ctx = document.getElementById('analyticsChart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: analyticsData,
            options: analyticsOptions
        });
    });
</script>
{% endblock %}
